{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string"
        },
        "prefix": {
            "type": "string"
        },
        "ImageGallery_Name": {
            "type": "string"
        },
        "Image": {
            "type": "string"
        },
        "VNET_Name": {
            "type": "string"
        },
        "subnet_Name": {
            "type": "string"
        },
        "LB_Name": {
            "type": "string"
        },
        "LB_BE_Pool_Name": {
            "type": "string"
        },
        "Subscription": {
            "type": "string"
        },
        "RG": {
            "type": "string"
        }
    },
    "functions": [],
    "variables": {
        "SubnetID":           "[concat('/subscriptions/',parameters('Subscription'),'/resourceGroups/',parameters('RG'),'/providers/Microsoft.Network/virtualNetworks/',parameters('VNET_Name'),'/subnets/',parameters('subnet_Name'))]",
        "VMSSNAme":           "[concat(parameters('prefix'),'_VMSS_',parameters('location'))]",
        "ImageGalleryString": "[concat('/subscriptions/',parameters('Subscription'),'/resourceGroups/',parameters('RG'),'/providers/Microsoft.Compute/galleries/',parameters('ImageGallery_Name'))]",
        "Full_Image_ID":      "[concat(variables('ImageGalleryString'),'/images/',parameters('Image'))]",
        "LB_String":          "[concat('/subscriptions/',parameters('Subscription'),'/resourceGroups/',parameters('RG'),'/providers/Microsoft.Network/loadBalancers/',parameters('LB_Name'))]"
        
    },
    "resources": [
        {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "apiVersion": "2021-03-01",
            "location": "[parameters('location')]",
            "name": "[variables('VMSSNAme')]",
                "sku": {
                    "name": "Standard_D2s_v3",
                    "tier": "Standard",
                    "capacity": 2
            },
            "zones": [
                "1",
                "2",
                "3"
            ],
            "properties": {
                "singlePlacementGroup": false,
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "scaleInPolicy": {
                    "rules": [
                        "Default"
                    ]
                },
                "virtualMachineProfile": {
                    "storageProfile": {
                        "osDisk": {
                            "osType": "Linux",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            },
                            "diskSizeGB": 20

                        },
                        "imageReference": {
                            "id": "[variables('Full_Image_ID')]"
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "CSUK-VNET-Backend-nic01",
                                "properties": {
                                    "primary": true,
                                    "enableAcceleratedNetworking": false,
                                    "dnsSettings": {
                                        "dnsServers": []
                                    },
                                    "enableIPForwarding": false,
                                    "ipConfigurations": [
                                        {
                                            "name": "CSUK-VNET-Backend-nic01-defaultIpConfiguration",
                                            "properties": {
                                                "primary": true,
                                                "subnet": {
                                                    "id": "[variables('SubnetID')]"
                                                },
                                                "privateIPAddressVersion": "IPv4",
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[concat(variables('LB_String'),'/backendAddressPools/',variables('VMSSNAme'))]"
                                                    }
                                                ]
                                            }

                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "diagnosticsProfile": {
                        "bootDiagnostics": {
                            "enabled": true
                        }
                    },
                    /*"extensionProfile": {
                        "extensions": [
                            {
                                "name": "DependencyAgentLinux",
                                "properties": {
                                    "autoUpgradeMinorVersion": true,
                                    "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                                    "type": "DependencyAgentLinux",
                                    "typeHandlerVersion": "9.10",
                                    "settings": {

                                    }
                                }
                            },
                            {
                                "name": "OMSAgentForLinux",
                                "properties": {
                                    "autoUpgradeMinorVersion": true,
                                    "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                                    "type": "OmsAgentForLinux",
                                    "typeHandlerVersion": "1.7",
                                    "settings": {
                                        "workspaceId": "7e12ccaa-f11b-4e1e-a449-7955952ae15f",
                                        "azureResourceId": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('VMSSNAme'))]",
                                        "stopOnMultipleConnections": "true"
                                    }
                                }
                            }
                        ]
                    }*/
                    "overprovision": true,
                    "doNotRunExtensionsOnOverprovisionedVMs": false,
                    "zoneBalance": false,
                    "platformFaultDomainCount": 5
                },
                
            "type": "Microsoft.Compute/virtualMachineScaleSets/virtualMachines",
            "apiVersion": "2021-03-01",
            "name": "[concat(variables('VMSSNAme'), '/2')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('VMSSNAme'))]"
            ],
            "sku": {
                "name": "Standard_D2s_v3",
                "tier": "Standard"
            },
            "zones": [
                "3"
            ],
            "properties": {
                "networkProfileConfiguration": {
                    "networkInterfaceConfigurations": [
                        {
                            "name": "CSUK-VNET-Backend-nic01",
                            "properties": {
                                "primary": true,
                                "enableAcceleratedNetworking": false,
                                /*
                                "networkSecurityGroup": {
                                    "id": "[parameters('networkSecurityGroups_basicNsgCSUK_VNET_Backend_nic01_externalid')]"
                                },
                                */
                                "dnsSettings": {
                                    "dnsServers": []
                                },
                                "enableIPForwarding": false,
                                "ipConfigurations": [
                                    {
                                        "name": "CSUK-VNET-Backend-nic01-defaultIpConfiguration",
                                        "properties": {
                                            "primary": true,
                                            "subnet": {
                                                "id": "[variables('SubnetID')]"
                                            },
                                            "privateIPAddressVersion": "IPv4",
                                            "loadBalancerBackendAddressPools": [
                                                {
                                                    "id": "[concat(variables('LB_String'),'/backendAddressPools/',parameters('LB_BE_Pool_Name'))]"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                },
                "hardwareProfile": {},
                "storageProfile": {
                    "imageReference": {
                        "id": "[variables('Full_Image_ID')]"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "csuk-vmss-api-02_csuk-vmss-api-02_2_OsDisk_1_a5f0b6ccf18446e8a2b4b3537a7d819d",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                            
                        },
                        "diskSizeGB": 30
                    },
                    "dataDisks": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[concat(resourceId('Microsoft.Compute/virtualMachineScaleSets/virtualMachines', variables('VMSSNAme'), '2'), '/networkInterfaces/CSUK-VNET-Backend-nic01')]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true
                    }
                }
            }
        }

        
    }
    ],
    "outputs": {}
}